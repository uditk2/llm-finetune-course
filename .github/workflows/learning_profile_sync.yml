name: Sync Learning Profile from Issue

on:
  issues:
    types: [opened, edited, reopened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to sync"
        required: true

permissions:
  contents: write
  issues: read

jobs:
  sync-profile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve Issue and Write Profile
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            let issue;
            if (context.eventName === 'workflow_dispatch') {
              const raw =
                core.getInput('issue_number') ||
                (context.payload.inputs && context.payload.inputs.issue_number) ||
                '';
              const issue_number = Number.parseInt(raw, 10);
              if (!issue_number || Number.isNaN(issue_number)) {
                core.setFailed(`workflow_dispatch requires a valid issue_number input. Got: '${raw}'`);
                return;
              }
              issue = await github.rest.issues.get({ owner, repo, issue_number });
            } else {
              issue = { data: context.payload.issue };
            }
            const fs = require('fs');
            const title = issue.data.title || '';
            const author = issue.data.user?.login || '';
            const body = issue.data.body || '';
            if (!/learning profile/i.test(title)) {
              core.info("Skip: title does not include 'Learning Profile'.");
              core.setOutput('wrote', 'false');
              return;
            }
            if (owner !== author) {
              core.info(`Skip: issue author is '${author}' not repo owner '${owner}'.`);
              core.setOutput('wrote', 'false');
              return;
            }
            // Prefer JSON in a fenced block ```json ... ```
            let content = '';
            const jsonFence = body.match(/```json\\s*([\\s\\S]*?)```/i);
            if (jsonFence && jsonFence[1]) {
              content = jsonFence[1].trim();
            } else {
              const anyFence = body.match(/```\\s*([\\s\\S]*?)```/);
              if (anyFence && anyFence[1]) {
                content = anyFence[1].trim();
              } else {
                const jsonObject = body.match(/\\{[\\s\\S]*\\}/);
                content = jsonObject ? jsonObject[0].trim() : body.trim();
              }
            }
            if (!content) {
              core.setFailed('Issue body is empty; nothing to sync.');
              return;
            }
            fs.writeFileSync('progress/learning_profile.md', content + '\n', 'utf8');
            core.setOutput('wrote', 'true');

      - name: Commit and Push
        if: steps.issue.outputs.wrote == 'true'
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add progress/learning_profile.md
          git commit -m "Sync learning profile from issue #${{ steps.issue.outputs.number }}"
          git push
